#AWS

---
**클라우드 컴퓨팅 서비스**
개인이나 기업이 소프트웨어 인프라를 쉽게 구축하고 관리할 수 있도록 해주는 서비스

아마존 웹 서비스(AWS) -> 2006년부터.

개발자만 접속 가능하고, 외부의 사용자가 접속할 수 없는 구조
- 어플리케이션 빌드(프로그램 코드를 컴퓨터가 실행할 수 있는 파일로 변환)
- 서버에 배포를 하면 외부 사용자도 접속 가능

서버 환경을 어떻게 구축하는가?
1. 온프레미스(On-Premise) 방식
	: 장비를 구입하고, 네트워크 환경을 구축해서 장비를 다룰 수 있는 엔지니어를 고용하여 운영 관리
	: 기술적, 경제적, 시간적 비용 발생
	
2. 클라우드 컴퓨팅 방식
	AWS 웹 어플리케이션 접속, 몇 가지 입력만으로 서버환경을 구축

---
### 1. 프로젝트 빌드
1-1. 프론트엔드 프로젝트 빌드

프론트엔드 빌드 파일 이동 자동화
-> static

 mv모듈 설치
 `npm i mv@2.1.1 -D `

해당 프로젝트 디렉토리에서 터미널 열고 실행: `npm run build`
-> dist 디렉토리에 작업 내용 생성됨

dist 내부의 모든 파일들을 src/main/resources/static 으로 이동
-> 이제 localhost:8080으로 프론트+백 통합됨

MainController 수정
```java
@Controller  
public class MainController {  
  
    @GetMapping(value = {"/", "{path:[^.]*}", "{path1:[^.]*}/{path2:[^.]*}"})  
    public String index() {  
        return "/index.html";  
    }  
}
```
index.html로 처음 화면 연결

백엔드 빌드 파일 생성

터미널에 `./gradlew bootJar` 입력
-> build/libs 폴더에 .jar 파일 생성 완료(최종 배포 파일!)

---
### 2. AWS EC2 생성
AWS 가입 후(프리 티어 권장) EC2 생성, 인스턴스 시작

Ubuntu 선택 (24.04 LTS)

t2.micro 선택 (다른 것도 가능, 프리 티어 가능 여부 확인)

키 페어 생성 - RSA, .pem 사용 -> 잘 보관해놓기

방화벽 - SSH, HTTPS 트래픽 허용 다 체크

스토리지 구성 - 8GiB gp3 (프리 티어 사용)

인스턴스 시작
 : 퍼블릭 DNS 주소 확인(외부에서 접속할 주소)

---
### 3. 서비스 환경 구축
SFTP 접속

IntelliJ(Ultimate) -> Tools -> Deployment -> Browse Remote Host 
Add Host -> 이름 입력, SFTP 선택
SSH Configurations 설정
Host : AWS EC2에서 복사한 퍼블릭 DNS 주소 입력
	SSH 포트는 22번
Username : ubuntu (고정)
인증방식 : Key pair
키 위치 : 로컬에 저장한 키.pem

커넥션 테스트 진행 
완료되면 그대로 복사해서 이름 변경 : study-root
	root 사용자(관리자)로 사용할 커넥션
Use sudo ~ 체크박스 체크하고 완료

Tools -> Start SSH Session 으로 접속 가능

터미널이 잘 표시되면 입력 :
`sudo apt update`

완료되면 jdk 설치를 위해 입력 :
`sudo apt-get install openjdk-21-jdk -y`

설치 완료 확인 : 
`java -version`

---
### 4. 원격 DB 접속
AWS EC2 Ubuntu에서 MySQL 8.0 설치

패키지 업데이트 
`sudo apt-get update`
`sudo apt-get upgrade -y`

MySQL APT 저장소 추가
`wget https://dev.mysql.com/get/mysql-apt-config_0.8.22-1_all.deb`

config 설정 
`sudo dpkg -i mysql-apt-config_0.8.22-1_all.deb`
  
설치중 설정 화면에서 8.0 선택 
OK 선택

APT 패키지 리스트 업데이트
`sudo apt-get update`

MySQL 8.0 설치
`sudo apt-get install mysql-server -y`

MySQL 서버시작
`sudo systemctl start mysql`

MySQL 서버 자동 시작 설정 (재부팅 시 자동 실행)
`sudo systemctl enable mysql`

MySQL 설치 확인
`mysql --version`

MySQL 서비스 상태 확인
`sudo systemctl status mysql`

root 보안 설정 (비밀번호 설정)
`sudo mysql_secure_installation`

```
| Validate Password Plugin?         | n 
| New root password?                | 원하는 비밀번호 입력(Key pair 사용시 없음) 
| Remove Anonymous Users?           | y               
| Disallow root remote login?       | y              
| Remove test DB?                   | y                
| Reload privileges now?            | y     
```

MySQL 접속 
`sudo mysql -u root -p`

외부 접속 허용 설정
`sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf`

`bind-address = 0.0.0.0  수정 후 저장 종료 (ctrl + O-> Enter-> ctrl + X)`

root 외부 접속 권한 부여
`ALTER USER 'root'@'%' IDENTIFIED WITH mysql_native_password BY '원하는비번';`
`FLUSH PRIVILEGES;`
 
재시작: 
`sudo systemctl restart mysql`

---
### 5. 웹 서버 설치
nginx 설치
`sudo apt-get install nginx -y`

서버 실행 시 enable 설정
`sudo systemctl enable nginx`

상태 확인
`sudo systemctl status nginx`

https로 접근하면 보안상의 문제로 접근이 제한되므로,
주소창에 DNS주소 또는 IP주소 입력 후 http 프로토콜로 바꿔준다.
-> 웹 서버 구동 성공시 "Welcome to nginx!" 페이지 표시

이후에 진행할 MySQL DB 커넥션(3306 포트)을 허용해주기 위해, 
AWS EC2에서 인바운드 규칙을 추가해준다.

인스턴스 -> '보안' 탭에서 '보안 그룹' 클릭(launch-wizard-1)
인바운드 규칙 편집 -> 규칙 추가 -> 유형 MySQL/Aurora -> 소스 Anywhere IPv4(0.0.0.0/0)
수정 완료

---
### 6. 사용자 생성
MySQL 접속
`sudo mysql -u root -p`

유저 생성
`create user 'ssg'@'%' identified by 'Ssgmysql1234!';`
-> 비번 규칙 때문에 맨 앞에 대문자 ...
`create user 'ssg'@'localhost' identified by 'ssgmysql1234!';`

유저에 권한 부여
`grant all privileges on *.* to 'ssg'@'%' with grant option;`
`grant all privileges on *.* to 'ssg'@'localhost' with grant option;`
`flush privileges;`

유저 확인
`select host, user from mysql.user;`
`quit`

IntelliJ Database -> Properties 에서 Connection 생성
Host : public DNS 주소 입력
Post : 3306
User : ssg (아까 권한 부여해준 유저)
Password : Ssgmysql1234! (아까 설정해준 비번)
	`'ssg'@'%'` 로 만들어준 계정

---
### 7. localhost -> AWS RDS로 DB 옮기기

AWS 커넥션에 우클릭 -> New -> Schema

Collation : `utf8mb4_general_ci` 선택

스키마 만들어지면 테이블 만들고 데이터 집어넣기

---
### 8. 배포

Tools -> Start SSH Session(터미널 열기)

home/ubuntu/applications/gallery를 만들어주어야 함

명령어 입력(계속):
`cd ~`
`cd .. cd .. pwd` -> / 가 되면
`cd /home/ubuntu`

`mkdir applications`
applications에서 `mkdir gallery`

프로젝트 안에 있는 .jar 파일을 applications/gallery로 드래그 & 드롭
`java -jar gallery-0.0.1-SNAPSHOT.jar`



리눅스에서는 설치파일들은 etc 디렉토리 안에 설치된다.
etc/nginx/sites-enabled에 파일 생성 : `default.conf`
```
server { 
	listen 80; 
	server_name ec2-54-180-85-242.ap-northeast-2.compute.amazonaws.com; 
	location / { 
	proxy_pass http://127.0.0.1:8080;
	proxy_http_version 1.1; 
	proxy_set_header Upgrade $http_upgrade; 
	proxy_set_header Connection "upgrade"; 
	proxy_set_header Host $host; 
	proxy_set_header X-Real-IP $remote_addr; 
	proxy_cache_bypass $http_upgrade; 
	} 
}
```




리버스 프록시 설정
웹 어플리케이션에 접속할 수 없는 이유?
-> AWS 서버 인스턴스의 방화벽에서 웹 어플리케이션이 사용하는 8080 포트를 허용하지 않음
- 새로운 방화벽 규칙을 추가
- 웹 서버인 Nginx에 리버스 프록시를 활용해서 해결

리버스 프록시란?

로드 밸런싱 - 부하를 분산시킴

일단 jar 파일의 application.properties도 수정이 필요하다.
localhost 대신에 퍼블릭 DNS나 IP주소 입력
username : ssg
password : Ssgmysql1234!

다시 빌드 후, applications/gallery에 넣어줌
